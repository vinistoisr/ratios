<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>The Iron Vanguard · Ratios Builder</title>
  <link rel="icon" href="/logo_transparent.png">
  <link rel="preload" as="image" href="/logo_transparent.png">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --bg:#0b0f14; --surface-0:#0f1520; --surface-1:#121a26; --surface-2:#17212e;
      --border:#263242; --text:#e6edf3; --muted:#9fb1c1; --accent:#2ecc71; --danger:#e35d6a;
      --pill:#1a2432; --pill-hover:#202c3d; --dropzone:#192330;
    }
    :root[data-theme="light"]{
      --bg:#f7fafc; --surface-0:#ffffff; --surface-1:#ffffff; --surface-2:#f1f5f9;
      --border:#e2e8f0; --text:#0b0f14; --muted:#475569; --accent:#16a34a; --danger:#dc2626;
      --pill:#f8fafc; --pill-hover:#eef2f7; --dropzone:#f1f5f9;
    }
    html,body{height:100%; background:var(--bg); color:var(--text)}
    *{box-sizing:border-box}
    .card{background:var(--surface-1); border:1px solid var(--border); border-radius:18px; overflow:hidden}
    .pill{background:var(--pill); border:1px solid var(--border); border-radius:12px}
    .pill:hover{background:var(--pill-hover)}
    .pill-draggable{cursor:grab}
    .pill-draggable:active{cursor:grabbing}
    .subtle{color:var(--muted)}
    .btn{border:1px solid var(--border); border-radius:12px}
    .btn-ghost{background:transparent}
    .btn-accent{background:var(--accent); color:#0b0f14}
    .btn-icon{width:28px; height:28px; display:inline-flex; align-items:center; justify-content:center; border-radius:8px}
    .outline-best{outline:2px solid var(--accent); outline-offset:2px; border-radius:10px}
    .dz{background:var(--dropzone); border:2px dashed var(--border); border-radius:14px}
    .dz.hover{border-color:var(--accent); background:#0e1a13}
    .x-btn{position:absolute; top:8px; right:8px; background:#2a3748; color:#cfd8e3; width:22px; height:22px; border-radius:999px; font-size:14px; line-height:22px; text-align:center}
    .x-btn:hover{background:#35465c}
    .stmt-grid{display:grid; grid-template-columns:repeat(3,1fr); gap:12px}
    .stmt-col{display:grid; grid-auto-rows:minmax(40px,auto); gap:10px}
    .pill-row{display:flex; align-items:center; justify-content:space-between; padding:8px 12px}

    /* baseline, subtle */
    .baseline-card{border-left:4px solid var(--accent);}

    /* ingredient highlight on baseline card */
    .highlight-glow{
      box-shadow:0 0 0 2px var(--accent) inset, 0 0 12px rgba(46,204,113,.35);
      background:rgba(46,204,113,.08);
    }
    /* Minimal, elegant scrollbars (vertical-only) */
:root{
  --scroll-thumb: rgba(255,255,255,0.25);
  --scroll-thumb-hover: rgba(255,255,255,0.40);
  --scroll-track: transparent;
}

/* Firefox */
.nice-scroll{
  scrollbar-width: thin;               /* thin track */
  scrollbar-color: var(--scroll-thumb) var(--scroll-track);
  scrollbar-gutter: stable both-edges; /* keeps layout steady */
  overscroll-behavior: contain;
}

/* WebKit (Chrome/Edge/Safari) */
.nice-scroll::-webkit-scrollbar{
  width: 6px;            /* thin vertical strip */
  height: 6px;           /* in case horizontal ever appears */
}
.nice-scroll::-webkit-scrollbar-track{
  background: var(--scroll-track);
}
.nice-scroll::-webkit-scrollbar-thumb{
  background: var(--scroll-thumb);
  border-radius: 999px;
}
.nice-scroll:hover::-webkit-scrollbar-thumb{
  background: var(--scroll-thumb-hover);
}

/* Optional: hide horizontal bar if any content spills */
.nice-scroll{
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch; /* smooth on iOS */
}

  </style>

  <!-- React 18 UMD + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const {useEffect, useRef, useState} = React;

    /* config */
    const AV_BASE = '/api/alpha';

    /* theme storage */
    const getTheme = () => localStorage.getItem('iv_theme') || 'dark';
    const applyTheme = t => document.documentElement.setAttribute('data-theme', t);
    const setTheme = t => { localStorage.setItem('iv_theme', t); applyTheme(t); };
    applyTheme(getTheme());

    /* labels and quick ratios */
    const KNOWN = {
      "Gross Profit/Revenue":"Gross Margin",
      "Net Income/Revenue":"Net Margin",
      "Net Income/Equity":"Return on Equity",
      "Net Income/Total Assets":"Return on Assets",
      "Current Assets/Current Liabilities":"Current Ratio",
      "Total Liabilities/Equity":"Debt to Equity",
      "Operating Income/Revenue":"Operating Margin",
      "Cash from Operations/Revenue":"Operating Cash Flow to Sales",
      "CapEx/Revenue":"CapEx to Revenue",
      "Total Assets/Equity":"Equity Multiplier",
      "Revenue/Total Assets":"Asset Turnover",
      "Free Cash Flow/Revenue":"FCF Margin",
    };

    const RATIO_MEANING = {
      "Gross Margin":"Profit left after COGS per dollar of sales.",
      "Net Margin":"Profit after all expenses per dollar of sales.",
      "Return on Equity":"Profit generated per dollar of shareholder equity.",
      "Return on Assets":"Profit generated per dollar of total assets.",
      "Current Ratio":"Ability to meet short term obligations with short term assets.",
      "Debt to Equity":"Leverage relative to equity, higher means more debt financed.",
      "Operating Margin":"Core operating profitability per dollar of sales.",
      "Operating Cash Flow to Sales":"Cash generation from operations per dollar of sales.",
      "CapEx to Revenue":"Investment intensity relative to sales.",
      "Equity Multiplier":"Balance sheet leverage, assets per dollar of equity.",
      "Asset Turnover":"Efficiency, sales generated per dollar of assets.",
      "FCF Margin":"Free cash flow generated per dollar of sales.",
    };

    const COMMON_RATIOS = [
      { name:"Current Ratio", n:"Current Assets", d:"Current Liabilities", tip:RATIO_MEANING["Current Ratio"] },
      { name:"Gross Margin", n:"Gross Profit", d:"Revenue", tip:RATIO_MEANING["Gross Margin"] },
      { name:"Net Margin", n:"Net Income", d:"Revenue", tip:RATIO_MEANING["Net Margin"] },
      { name:"Operating Margin", n:"Operating Income", d:"Revenue", tip:RATIO_MEANING["Operating Margin"] },
      { name:"ROE", n:"Net Income", d:"Equity", tip:RATIO_MEANING["Return on Equity"] },
      { name:"ROA", n:"Net Income", d:"Total Assets", tip:RATIO_MEANING["Return on Assets"] },
      { name:"Debt to Equity", n:"Total Liabilities", d:"Equity", tip:RATIO_MEANING["Debt to Equity"] },
      { name:"Op CF to Sales", n:"Cash from Operations", d:"Revenue", tip:RATIO_MEANING["Operating Cash Flow to Sales"] },
      { name:"CapEx to Revenue", n:"CapEx", d:"Revenue", tip:RATIO_MEANING["CapEx to Revenue"] },
      { name:"Asset Turnover", n:"Revenue", d:"Total Assets", tip:RATIO_MEANING["Asset Turnover"] },
      { name:"FCF Margin", n:"Free Cash Flow", d:"Revenue", tip:RATIO_MEANING["FCF Margin"] },
    ];

    const fmtMoney = n=>{
      if (n==null || Number.isNaN(n)) return "N/A";
      const a=Math.abs(n);
      const unit=a>=1e9?"B":a>=1e6?"M":a>=1e3?"K":"";
      const base=unit==="B"?n/1e9:unit==="M"?n/1e6:unit==="K"?n/1e3:n;
      return `${base.toFixed(2)}${unit}`;
    };
    const ratioLabel=(num,den)=>KNOWN[`${num}/${den}`]||`${num} ÷ ${den}`;
    const higherIsBetter=label=>/debt to equity/i.test(label)?false:true;

    const Tag=({children})=><span className="px-2 py-0.5 rounded-full text-[11px] subtle border" style={{borderColor:'var(--border)'}}>{children}</span>;
    const IconBtn=({onClick, title, children})=><button className="btn btn-ghost btn-icon" style={{borderColor:'var(--border)'}} title={title} onClick={onClick}>{children}</button>;

    // simple request log 
    const DEBUG = new (class {
      list = [];
      push(x){ this.list = [...this.list, x]; console.debug("[AV]", x); }
    })();
    
    async function fetchJson(u){
      const t0 = Date.now();
      const r = await fetch(u); // allow browser reuse within session
      const txt = await r.text();
      let j = null;
      try { j = JSON.parse(txt); } catch {}

      DEBUG.push({
        url: u, status: r.status, ms: Date.now()-t0,
        avNote: j?.Note, avInfo: j?.Information, avErr: j?.["Error Message"],
        proxyErr: j?.error, proxyDetail: j?.detail
      });

      if (!r.ok) {
        const msg = j?.error || `HTTP ${r.status}`;
        const detail = j?.detail || j?.["Error Message"] || j?.Note || j?.Information;
        const e = new Error(detail ? `${msg}: ${detail}` : msg);
        e.retryAfter = r.headers.get("Retry-After");
        throw e;
      }
      if (j?.Note || j?.Information || j?.["Error Message"]) {
        // Alpha sometimes returns 200 with a Note/Information when throttled
        const e = new Error("rate_limited");
        e.retryAfter = r.headers.get("Retry-After");
        throw e;
      }
      return j;
    }

    // 72h local persistence for fundamentals
    const TTL_MS = 72 * 60 * 60 * 1000;
    const LS_KEY = "av_cache_v1";
    let LS = {};
    try { LS = JSON.parse(localStorage.getItem(LS_KEY) || "{}"); } catch {}

    function getLocal(key) {
      const v = LS[key];
      if (!v) return null;
      if (Date.now() - v.t > TTL_MS) return null;
      return v.data;
    }

    function putLocal(key, data) {
      LS[key] = { t: Date.now(), data };
      try {
        const keys = Object.keys(LS);
        if (keys.length > 600) {
          const arr = keys.map(k => [k, LS[k]?.t || 0]).sort((a,b)=>a[1]-b[1]);
          for (let i = 0; i < Math.min(30, arr.length); i++) delete LS[arr[i][0]];
        }
        localStorage.setItem(LS_KEY, JSON.stringify(LS));
      } catch {}
    }

    
    const mem = new Map();
    function cached(key, loader){
      const hit = getLocal(key);
      if (hit) return Promise.resolve(hit);

      if (mem.has(key)) return mem.get(key);

      const p = loader()
        .then(data => { putLocal(key, data); return data; })
        .catch(e => { mem.delete(key); throw e; });

      mem.set(key, p);
      return p;
    }
    
    const symKey = s => (s || "").trim().toUpperCase();
    const avUrl = (fn, sym) => `${AV_BASE}?function=${fn}&symbol=${encodeURIComponent(symKey(sym))}`;
    const avIncome   = sym => cached(`IS:${symKey(sym)}`, () => fetchJson(avUrl('INCOME_STATEMENT', sym)));
    const avBalance  = sym => cached(`BS:${symKey(sym)}`, () => fetchJson(avUrl('BALANCE_SHEET', sym)));
    const avCash     = sym => cached(`CF:${symKey(sym)}`, () => fetchJson(avUrl('CASH_FLOW', sym)));
    const avOverview = sym => cached(`OV:${symKey(sym)}`, () => fetchJson(avUrl('OVERVIEW', sym)));

    function mapFromAV(ticker, is, bs, cf, ov){
      const out = { name: (ov && ov.Name) ? ov.Name : ticker, statements: {} };
      const isReports = (is && is.annualReports) ? is.annualReports : [];
      const bsReports = (bs && bs.annualReports) ? bs.annualReports : [];
      const cfReports = (cf && cf.annualReports) ? cf.annualReports : [];

      for (const row of isReports) {
        const y = Number(row.fiscalDateEnding ? row.fiscalDateEnding.slice(0,4) : "");
        if (!y) continue;
        if (!out.statements[y]) out.statements[y] = { IncomeStatement:{}, BalanceSheet:{}, CashFlow:{} };
        out.statements[y].IncomeStatement = {
          Revenue:+row.totalRevenue||0,
          "Cost of Revenue":+row.costOfRevenue||0,
          "Gross Profit":+row.grossProfit||0,
          "Operating Income":+row.operatingIncome||0,
          "Net Income":+row.netIncome||0,
        };
      }
      for (const row of bsReports) {
        const y = Number(row.fiscalDateEnding ? row.fiscalDateEnding.slice(0,4) : "");
        if (!y) continue;
        if (!out.statements[y]) out.statements[y] = { IncomeStatement:{}, BalanceSheet:{}, CashFlow:{} };
        out.statements[y].BalanceSheet = {
          "Total Assets":+row.totalAssets||0,
          "Total Liabilities":+row.totalLiabilities||0,
          Equity:+row.totalShareholderEquity||0,
          "Current Assets":+row.totalCurrentAssets||0,
          "Current Liabilities":+row.totalCurrentLiabilities||0,
        };
      }
      for (const row of cfReports) {
        const y = Number(row.fiscalDateEnding ? row.fiscalDateEnding.slice(0,4) : "");
        if (!y) continue;
        if (!out.statements[y]) out.statements[y] = { IncomeStatement:{}, BalanceSheet:{}, CashFlow:{} };
        const op = +row.operatingCashflow||0;
        const capex = +row.capitalExpenditures||0;
        out.statements[y].CashFlow = {
          "Cash from Operations":op,
          CapEx:capex,
          "Free Cash Flow":op+capex,
        };
      }
      return out;
    }

    async function fetchStatements(ticker){
      const s = symKey(ticker);
    
      // Try one call per ticker first
      try {
        const bundle = await cached(`BUNDLE:${s}`, () =>
          fetchJson(`${AV_BASE}?bundle=1&symbol=${encodeURIComponent(s)}`)
        );
        return mapFromAV(s, bundle.income_statement, bundle.balance_sheet, bundle.cash_flow, bundle.overview);
      } catch (_e) {
        // Fallback to four per function, uses your existing caches
        const [is, bs, cf, ov] = await Promise.all([
          avIncome(s),
          avBalance(s),
          avCash(s),
          avOverview(s),
        ]);
        return mapFromAV(s, is, bs, cf, ov);
      }
    }

    /* UI parts */
    function DropZone({label,onDropData,filled}){
      const [hover,setHover]=useState(false);
      function onDrop(e){
        e.preventDefault();
        const raw=e.dataTransfer.getData("text/plain");
        try{const d=JSON.parse(raw); if(typeof d.value==="number") onDropData(d);}catch(_){}
        setHover(false);
      }
      return (
        <div className={`dz px-5 py-6 min-h-[120px] rounded-xl ${hover?"hover":""}`}
          onDragOver={e=>{e.preventDefault(); setHover(true);}}
          onDragLeave={()=>setHover(false)}
          onDrop={onDrop}>
          <div className={`font-medium ${filled?"text-lg":"text-lg subtle"}`}>{label}</div>
          {!filled && <div className="text-[11px] subtle mt-1">Drag a line item here</div>}
        </div>
      );
    }

    function RatioBuilder({onMakeRatio}){
      const [num,setNum]=useState(null);
      const [den,setDen]=useState(null);
      const build = ()=>{ if(num && den){ onMakeRatio(num,den); setNum(null); setDen(null); } };

      return (
        <div className="card p-3">
          <div className="flex items-center justify-between mb-4">
            <div className="text-lg font-semibold">Financial Ratio Builder</div>
            <div className="flex items-center gap-2">
              <button className="btn btn-accent px-3 py-2" onClick={build} title="Add ratio">+</button>
            </div>
          </div>

          <div className="flex items-stretch gap-4">
            <div className="flex-1">
              <DropZone label={num?`Numerator: ${num.label}`:"Drop Numerator"} onDropData={setNum} filled={!!num}/>
            </div>
            <div className="flex items-center justify-center px-2 select-none">
              <span className="text-3xl subtle">÷</span>
            </div>
            <div className="flex-1">
              <DropZone label={den?`Denominator: ${den.label}`:"Drop Denominator"} onDropData={setDen} filled={!!den}/>
            </div>
          </div>

          <div className="flex flex-wrap gap-2 pt-3">
            {COMMON_RATIOS.map(r=>(
              <button
                key={r.name}
                className="btn btn-ghost text-[12px] px-2.5 py-1.5"
                style={{borderColor:'var(--border)'}}
                title={`${r.name}. ${r.tip}`}
                onClick={()=>onMakeRatio({label:r.n,value:1},{label:r.d,value:1})}
              >
                {r.name}
              </button>
            ))}
          </div>
        </div>
      );
    }

    function AiPanel({ items, ratioDefs, baselineIdx }) {
      const [loading, setLoading] = React.useState(false);
      const [text, setText] = React.useState("");
      const [err, setErr] = React.useState("");

      function pool(c) {
        const y = c.years[c.yearIndex];
        const s = (c.data && c.data.statements) ? c.data.statements[y] : {};
        const inc = s?.IncomeStatement || {};
        const bal = s?.BalanceSheet || {};
        const cfs = s?.CashFlow || {};
        return { year: y, metrics: { ...inc, ...bal, ...cfs } };
      }

      function buildPayload() {
        const compactCompanies = items.map(it => {
          const { year, metrics } = pool(it);
          const ratios = ratioDefs.map(r => {
            const n = metrics[r.numerator];
            const d = metrics[r.denominator];
            const v = (typeof n === "number" && typeof d === "number" && d !== 0) ? n / d : null;
            return { label: r.label, numerator: r.numerator, denominator: r.denominator, value: v };
          });
          const keep = (k) => metrics[k] ?? null;
          const head = {
            Revenue: keep("Revenue"),
            "Gross Profit": keep("Gross Profit"),
            "Operating Income": keep("Operating Income"),
            "Net Income": keep("Net Income"),
            "Total Assets": keep("Total Assets"),
            Equity: keep("Equity"),
            "Total Liabilities": keep("Total Liabilities"),
            "Current Assets": keep("Current Assets"),
            "Current Liabilities": keep("Current Liabilities"),
            "Cash from Operations": keep("Cash from Operations"),
            CapEx: keep("CapEx"),
            "Free Cash Flow": keep("Free Cash Flow"),
          };
          return { ticker: it.ticker, name: it.name, year, headline: head, ratios };
        });

        return {
          companies: compactCompanies,
          ratioDefs: ratioDefs.map(r => ({ label: r.label, numerator: r.numerator, denominator: r.denominator })),
          baselineIdx
        };
      }

      async function run() {
        try {
          setLoading(true); setErr(""); setText("");
          const res = await fetch("/api/analyze", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(buildPayload())
          });
          const j = await res.json();
          if (!res.ok) throw new Error(j.error || "Analysis failed");
          setText((j.text || "").trim());
        } catch (e) {
          setErr(String(e));
        } finally {
          setLoading(false);
        }
      }

      return (
        <div className="card p-3">
          <div className="flex items-center justify-between mb-2">
            <div className="text-sm font-semibold">AI Analysis</div>
            <button
              className="btn btn-accent px-3 py-2"
              onClick={run}
              disabled={loading || items.length === 0}
              title="Generate a concise comparison"
            >
              {loading ? "Analyzing…" : "Generate"}
            </button>
          </div>
          {err && <div className="text-[12px]" style={{color:"var(--danger)"}}>{err}</div>}
          <div className="text-[13px] whitespace-pre-wrap">
            {text || "Click Generate to produce an ai-summary comparing the visible companies using the active ratios and selected years."}
          </div>
        </div>
      );
    }

    function CompanyCard({company,isBaseline,onRemove,onBack,onForward,highlightKeys,onRetry}){
      const y=company.years[company.yearIndex];
      const s=(company.data && company.data.statements) ? company.data.statements[y] : null;
      const inc = s && s.IncomeStatement ? s.IncomeStatement : null;
      const bal = s && s.BalanceSheet ? s.BalanceSheet : null;
      const cfs = s && s.CashFlow ? s.CashFlow : null;
      const blocks=[
        {title:"INCOME",data:inc},
        {title:"BALANCE",data:bal},
        {title:"CASH FLOW",data:cfs},
      ];
      return (
        <div className={`card p-3 relative ${isBaseline?'baseline-card':''}`}>
          <div className="absolute right-2 top-2">
            <button className="x-btn" title="Remove" onClick={onRemove}>×</button>
          </div>
          <div className="pr-8">
            <div className="flex items-center justify-between mb-2">
              <div className="font-semibold text-sm truncate pr-2" title={`${company.ticker} · ${(company.name||company.ticker)}`}>
                {company.name || company.ticker} <span className="subtle">({company.ticker})</span>
                {isBaseline && <span className="ml-2 text-[10px] px-2 py-0.5 rounded-full border" style={{borderColor:'var(--border)'}}>Baseline</span>}
              </div>
              <div className="flex items-center gap-2">
                <IconBtn title="Back one year" onClick={onBack}><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M15.5 19 8.5 12l7-7"/></svg></IconBtn>
                <Tag>{y||"No Year"}</Tag>
                <IconBtn title="Forward one year" onClick={onForward}><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M8.5 5 15.5 12l-7 7"/></svg></IconBtn>
              </div>
            </div>
            {company.error && (
              <div className="mb-2 text-[12px] p-2 rounded-md"
                   style={{background:"rgba(227,93,106,.12)", border:"1px solid #e35d6a"}}>
                <div className="font-medium" style={{color:"#e35d6a"}}>Data error</div>
                <div className="mt-0.5 subtle">{company.error}</div>
                <button className="mt-2 btn btn-ghost px-2 py-1"
                        style={{borderColor:'var(--border)'}}
                        onClick={onRetry}>
                  Retry
                </button>
              </div>
            )}
            <div className="stmt-grid">
              {blocks.map(b=>(
                <div key={b.title}>
                  <div className="text-[11px] subtle mb-1">{b.title}</div>
                  <div className="stmt-col">
                    {b.data
                      ? Object.entries(b.data).map(([k,v])=>(
                          <LineItem
                            key={k}
                            label={k}
                            value={typeof v==='number'?v:null}
                            highlight={!!(highlightKeys && highlightKeys.has(k))}
                          />
                        ))
                      : <div className="text-[12px] subtle p-2">No data</div>
                    }
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    function AddCard({onClick}){
      return (
        <button className="card p-3 h-[64px] flex items-center justify-center subtle w-full"
          style={{background:'var(--surface-0)'}} onClick={onClick} title="Add empty ticker slot">
          <span className="flex items-center gap-2"><span className="btn-icon btn-ghost" style={{border:'1px solid var(--border)'}}>+</span> Add ticker slot</span>
        </button>
      );
    }

    function EmptyTickerCard({onAdd}){
      const [val,setVal]=useState("");
      function submit(){ onAdd(val); setVal(""); }
      return (
        <div className="card p-3 flex flex-col gap-2">
          <div className="font-semibold text-sm">Add Ticker</div>
          <div className="flex items-center gap-2">
            <input
              id="ticker"            // add
              name="ticker"          // add
              value={val}
              onChange={e=>setVal(e.target.value)}
              onKeyDown={e=>{ if(e.key==="Enter") submit(); }}
              placeholder="e.g.: TSLA"
              className="px-3 py-2 rounded-xl btn w-[160px]"
              style={{background:'var(--surface-0)',borderColor:'var(--border)'}}
            />
            <button className="btn btn-accent px-3 py-2" onClick={submit}>+</button>
          </div>
        </div>
      );
    }

    function LineItem({label,value,highlight}){
      function onDragStart(e){ e.dataTransfer.setData("text/plain", JSON.stringify({label,value})); }
      return (
        <div
          className={`pill pill-draggable pill-row text-[13px] ${highlight?'highlight-glow':''}`}
          draggable
          onDragStart={onDragStart}
          title="Drag into Financial Ratio Builder"
        >
          <span>{label}</span>
          <span className="subtle tabular-nums">{value==null?"N/A":fmtMoney(value)}</span>
        </div>
      );
    }

    function CompareTable({items,ratioDefs,baselineIdx,setBaselineIdx,removeRatio,clearAll,onHover,onLeave}){

      function pool(c){
        const y=c.years[c.yearIndex];
        const s=(c.data && c.data.statements) ? c.data.statements[y] : null;
        const inc=s && s.IncomeStatement ? s.IncomeStatement : {};
        const bal=s && s.BalanceSheet ? s.BalanceSheet : {};
        const cfs=s && s.CashFlow ? s.CashFlow : {};
        return {...inc,...bal,...cfs};
      }
      function val(c,def){
        const p=pool(c); const n=p[def.numerator], d=p[def.denominator];
        if(typeof n!=="number"||typeof d!=="number"||d===0) return null;
        return n/d;
      }
      const baseItem = items.find(it => it._idx === baselineIdx);
      const baseValFor = r => baseItem ? val(baseItem, r) : null;

      return (
          <div className="card p-3 h-full overflow-auto nice-scroll">
          <div className="flex items-center justify-between mb-2">
            <div className="text-sm font-semibold">Ratio</div>
            <button className="text-xs btn btn-ghost px-2 py-1" style={{borderColor:'var(--border)'}} title="Remove all ratios" onClick={clearAll}>
              Clear all
            </button>
          </div>
          <table className="w-full text-[13px]">
            <thead>
              <tr className="text-left border-b" style={{borderColor:'var(--border)'}}>
                <th className="py-2 pr-3">Ratio</th>
                {items.map((it)=>(
                  <th key={it._idx}
                      className={`py-2 pr-3 whitespace-nowrap cursor-pointer ${it._idx===baselineIdx?'border-b-2':''}`}
                      style={{borderColor: it._idx===baselineIdx ? 'var(--accent)' : 'transparent'}}
                      title={`${it.name || it.ticker}. Click to set as baseline`}
                      onClick={()=>setBaselineIdx(it._idx)}>
                    {it.ticker} {it.years[it.yearIndex]?`(${it.years[it.yearIndex]})`:""}
                  </th>
                ))}
              </tr>
            </thead>
            <tbody>
              {ratioDefs.length===0
                ? <tr><td colSpan={items.length+1} className="py-3 subtle">Define a ratio by dragging items, or use the presets.</td></tr>
                : ratioDefs.map((r,ri)=>{
                    const vals=items.map(it=>val(it,r));
                    const baseVal=baseValFor(r);
                    let bestIdx=-1, bestVal=null;
                    vals.forEach((v,i)=>{ if(v==null) return;
                      if(bestVal==null){bestVal=v; bestIdx=i; return;}
                      const better=higherIsBetter(r.label)?v>bestVal:v<bestVal;
                      if(better){bestVal=v; bestIdx=i;}
                    });

                    const meaning = RATIO_MEANING[r.label] || `${r.numerator} per ${r.denominator}.`;

                    return (
                      <tr key={ri} className="border-b" style={{borderColor:'var(--border)'}}>
                        <td className="py-2 pr-3 align-top">
                          <div className="flex items-center gap-2">
                            <div>
                              <div className="font-medium">{r.label}</div>
                              <div className="text-[11px] subtle">{r.numerator} / {r.denominator}</div>
                            </div>
                            <button
                              className="ml-1 text-xs btn btn-ghost px-2 py-1"
                              style={{borderColor:'var(--border)'}}
                              title="Remove this ratio"
                              onClick={()=>removeRatio(ri)}
                            >×</button>
                          </div>
                        </td>
                        {items.map((it,i)=>{
                          const p=pool(it);
                          const n=p[r.numerator];
                          const d=p[r.denominator];
                          const v=vals[i];
                          const isPct=/Margin|Return|to Sales|FCF|Operating Margin/i.test(r.label);
                          const txt=v==null?"N/A":isPct?`${(v*100).toFixed(1)}%`:v.toFixed(2);
                          let badge=null, color="";
                          if(baseVal!=null && v!=null && it._idx!==baselineIdx && Math.abs(baseVal)>0){
                            const diff=((v-baseVal)/Math.abs(baseVal))*100;
                            const better=higherIsBetter(r.label)?diff>0:diff<0;
                            badge=`${diff>=0?"+":""}${diff.toFixed(1)}%`;
                            color=better?"var(--accent)":"#c0392b";
                          }
                          const best=i===bestIdx && v!=null;
                          const tip = (typeof n==='number' && typeof d==='number' && d!==0)
                            ? `${r.numerator} (${fmtMoney(n)}) ÷ ${r.denominator} (${fmtMoney(d)}) = ${txt}. ${meaning}`
                            : `Not enough data to compute. ${meaning}`;

                          return (
                              <td
                                key={it._idx}
                                className="py-2 pr-3 tabular-nums align-top"
                                title={tip}
                                onPointerEnter={()=>onHover?.(it._idx, r)}
                                onPointerLeave={()=>onLeave?.()}
                              >
                              <div className={`inline-block px-2 py-1 rounded-md ${best?"outline-best":""}`}>
                                <span>{txt}</span>
                                {badge && <span className="ml-1 text-[11px]" style={{color}}>({badge})</span>}
                              </div>
                            </td>
                          );
                        })}
                      </tr>
                    );
                  })}
            </tbody>
          </table>
        </div>
      );
    }

    /* App */
    function App(){
      const [companies,setCompanies]=useState([]);
      const [ratioDefs,setRatioDefs]=useState([]);
      const [baselineIdx,setBaselineIdx]=useState(0);
      const [themeUI,setThemeUI]=useState(getTheme());
      const [highlightSet,setHighlightSet]=useState(null);
      const hlTimerRef = useRef(null);

      function toggleTheme(){
        const next = getTheme()==="dark" ? "light" : "dark";
        setTheme(next);
        setThemeUI(next);
      }

      function addTickerSlot(){
        setCompanies(p=>[...p,{ticker:"",name:"",data:{statements:{}},years:[],yearIndex:0,isEmpty:true}]);
      }
      async function replaceEmptyWith(t,at){
      const T=(t||"").trim().toUpperCase(); if(!T) return;
      setCompanies(p=>p.map((c,i)=> i===at ? {ticker:T,name:"Loading...",data:{statements:{}},years:[],yearIndex:0,loading:true} : c));
      try{
        const payload=await fetchStatements(T);
        const years=Object.keys(payload.statements||{}).map(Number).sort((a,b)=>b-a);
        const normalized={ticker:T,name:payload.name||T,data:payload,years,yearIndex:0,error:null};
        setCompanies(p=>p.map((c,i)=> i===at ? normalized : c));
      }catch(e){
        // keep the card, show the provider/ proxy error, allow retry
        setCompanies(p=>p.map((c,i)=> i===at
          ? { ticker:T, name:T, data:{statements:{}}, years:[], yearIndex:0, error:String(e), isEmpty:false }
          : c
        ));
      }
    }

      function removeCompany(i){
        setCompanies(p=>{
          const out = p.filter((_,idx)=>idx!==i);
          if (baselineIdx===i && out.length>0) setBaselineIdx(0);
          else if (baselineIdx>i) setBaselineIdx(b=>b-1);
          return out;
        });
      }
      function shiftYear(i,dir){
        setCompanies(p=>p.map((c,idx)=>{
          if(idx!==i) return c;
          const max = Math.max(0, c.years.length-1);
          const next = Math.min(Math.max(c.yearIndex + (dir<0?+1:-1), 0), max);
          return {...c, yearIndex: next};
        }));
      }
      function makeRatio(n,d){
        const lbl=ratioLabel(n.label,d.label);
        const entry={numerator:n.label,denominator:d.label,label:lbl};
        setRatioDefs(p=>p.some(r=>r.numerator===entry.numerator && r.denominator===entry.denominator)?p:[...p,entry]);

        // highlight ingredients on baseline
        if (hlTimerRef.current) clearTimeout(hlTimerRef.current);
        setHighlightSet(new Set([n.label, d.label]));
        hlTimerRef.current = setTimeout(()=>setHighlightSet(null), 3500);
      }
      function removeRatio(idx){
        setRatioDefs(p=>p.filter((_,i)=>i!==idx));
      }
      function clearAll(){
        setRatioDefs([]);
      }


      const [hoverHi, setHoverHi] = useState(null); // { idx:number, set:Set<string> } | null
      useEffect(() => { setHoverHi(null); }, [ratioDefs, companies.length]);
      
      function handleHover(idx, r){
         setHoverHi({ idx, set: new Set([r.numerator, r.denominator]) });
       }
       function clearHover(){
         setHoverHi(null);
       }


      
      const filled = companies.flatMap((c,i)=> c.isEmpty ? [] : [{...c, _idx:i}]);

      return (
        <div className="min-h-screen">
          <header className="p-4 flex items-center justify-between card" style={{background:'var(--surface-0)'}}>
            <div className="flex items-center gap-3">
              <img
                src="logo_transparent.png"
                alt="Iron Vanguard logo"
                className="h-10 w-10 rounded-md object-contain"
                height="40"
                width="40"
                loading="eager"
                decoding="async"
              />
              <div>
                <div className="text-lg font-semibold tracking-wide">The Iron Vanguard</div>
                <div className="text-[11px] subtle">Ratios Builder</div>
              </div>
            </div>
            <button
              className="btn btn-ghost px-3 py-2"
              style={{borderColor:'var(--border)'}}
              onClick={toggleTheme}
              title="Toggle light or dark"
              aria-label="Toggle theme"
            >
              {/* sun + moon icon */}
              <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                <path fill="currentColor" d="M12 4a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0V5a1 1 0 0 1 1-1Zm0 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8ZM4 11H3a1 1 0 1 0 0 2h1a1 1 0 1 0 0-2Zm18 0h-1a1 1 0 1 0 0 2h1a1 1 0 1 0 0-2ZM6.3 6.3a1 1 0 0 1 1.4 0l.7.7a1 1 0 1 1-1.4 1.4l-.7-.7a1 1 0 0 1 0-1.4Zm9.3 9.3a1 1 0 0 1 1.4 0l.7.7a1 1 0 1 1-1.4 1.4l-.7-.7a1 1 0 0 1 0-1.4ZM6.3 17.7a1 1 0 0 1 1.4 0l.7.7a1 1 0 0 1-1.4 1.4l-.7-.7a1 1 0 0 1 0-1.4Zm9.3-9.3a1 1 0 0 1 1.4 0l.7.7a1 1 0 1 1-1.4 1.4l-.7-.7a1 1 0 0 1 0-1.4Z"/>
              </svg>
            </button>
          </header>

          {/* top row: builder left, results right */}
          <section className="p-4 mb-8 isolate">
            <div className="grid grid-cols-1 xl:grid-cols-12 gap-4">
              <div className="xl:col-span-6 flex flex-col gap-4 min-h-0">
                <RatioBuilder onMakeRatio={makeRatio} />
                  <AiPanel items={filled} ratioDefs={ratioDefs} baselineIdx={baselineIdx} />
              </div>
          
              <div className="xl:col-span-6 min-h-0">
                <CompareTable
                  items={filled}
                  ratioDefs={ratioDefs}
                  baselineIdx={baselineIdx}
                  setBaselineIdx={setBaselineIdx}
                  removeRatio={removeRatio}
                  clearAll={clearAll}
                  onHover={handleHover}
                  onLeave={clearHover}
                />
              </div>
            </div>
          </section>


          <main className="px-4 pb-4">
            <section className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
              {companies.map((c,idx)=>(
                c.isEmpty
                  ? <EmptyTickerCard key={`empty-${idx}`} onAdd={(t)=>replaceEmptyWith(t,idx)} />
                  : <CompanyCard
                      key={c.ticker||idx}
                      company={c}
                      isBaseline={idx===baselineIdx}
                      onRemove={()=>removeCompany(idx)}
                      onBack={()=>shiftYear(idx,-1)}
                      onForward={()=>shiftYear(idx,+1)}
                      highlightKeys={(hoverHi && hoverHi.idx===idx ? hoverHi.set : null) || (idx===baselineIdx ? highlightSet : null)}
                      onRetry={()=>replaceEmptyWith(c.ticker, idx)}
                    />
              ))}

              <AddCard onClick={addTickerSlot}/>
            </section>
          </main>

          <footer className="px-4 pb-6 text-[11px] subtle text-center">
            Created for MBA520 at University of Victoria, Class of 2025, THE IRON VANGUARD team. Financial information sourced from Alpha Vantage.
          </footer>
        </div>
      );
    }

    const root=ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App/>);
  </script>
</body>
</html>

















